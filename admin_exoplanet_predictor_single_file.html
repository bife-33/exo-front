<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | Exoplanet Predictor</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#7c3aed; --accent-2:#06b6d4; --success:#10b981; --danger:#ef4444; --glass: rgba(255,255,255,0.03);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071025 0%, #071226 60%);color:#e6eef8}
    .app{display:grid;grid-template-columns:260px 1fr;gap:24px;min-height:100vh;padding:28px}

    /* Sidebar */
    .sidebar{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    .brand{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800}
    .menu{display:flex;flex-direction:column;gap:8px}
    .menu button{background:transparent;border:0;color:var(--muted);text-align:left;padding:10px;border-radius:8px;cursor:pointer}
    .menu button.active{background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06));color:#fff}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .search{background:var(--glass);padding:8px 12px;border-radius:10px;display:flex;gap:8px;align-items:center;color:var(--muted)}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,0.45)}
    .muted{color:var(--muted);font-size:13px}

    /* Tables and forms */
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;text-align:left;font-size:13px}
    thead th{color:var(--muted);font-weight:600;font-size:12px}
    tbody tr{border-top:1px solid rgba(255,255,255,0.03)}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    /* Upload zones */
    .upload{border:1px dashed rgba(255,255,255,0.06);padding:18px;border-radius:8px;text-align:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    input[type=file]{display:none}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;align-items:center;justify-content:center}
    .modal{width:760px;max-width:96%;background:linear-gradient(180deg,#061022 0%, #071025 100%);padding:18px;border-radius:12px}

    /* Responsive */
    @media (max-width:900px){.app{grid-template-columns:1fr;padding:14px}.sidebar{display:flex;flex-direction:row;overflow:auto;gap:8px}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">EP</div>
        <div>
          <div style="font-weight:700">ExoAdmin</div>
          <div class="muted" style="font-size:12px">Predictor & Training</div>
        </div>
      </div>
      <nav class="menu" id="menu">
        <button class="active" data-view="dashboard">Dashboard</button>
        <button data-view="users">Usu√°rios</button>
        <button data-view="training">Treinamento</button>
        <button data-view="predict">Previs√£o</button>
        <button data-view="history">Hist√≥rico</button>
        <button data-view="settings">Configura√ß√µes</button>
      </nav>
      <div style="margin-top:18px;display:flex;gap:8px">
        <button class="btn ghost" id="exportUsers">Exportar usu√°rios</button>
        <button class="btn" id="clearStorage">Reset</button>
      </div>
    </aside>

    <main>
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="search"><span>üîé</span><input id="search" placeholder="Pesquisar..." style="background:transparent;border:0;color:inherit;outline:0"/></div>
          <div class="muted">Models: <strong id="modelName">--</strong> ¬∑ Acur√°cia: <strong id="modelAcc">--</strong></div>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
          <div style="text-align:right">
            <div style="font-weight:700">Ol√°, Admin</div>
            <div class="muted" style="font-size:12px">√öltimo login: hoje</div>
          </div>
          <button class="btn primary" id="newUserBtn">Novo Usu√°rio</button>
        </div>
      </div>

      <!-- Views -->
      <section id="view-container">
        <!-- Dashboard -->
        <div class="view" id="dashboard">
          <div class="grid">
            <div class="card">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="muted">Model atual</div>
                  <div style="font-weight:700;font-size:20px" id="dashModel">Nenhum treinado</div>
                </div>
                <div style="text-align:right">
                  <div class="muted">Acur√°cia</div>
                  <div style="font-weight:700;font-size:18px" id="dashAcc">--</div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="muted">Treinamentos recentes</div>
              <div id="trainList" style="margin-top:10px"></div>
            </div>

            <div class="card">
              <div class="muted">Previs√µes recentes</div>
              <div id="predList" style="margin-top:10px"></div>
            </div>

            <div class="card">
              <canvas id="accChart" height="140"></canvas>
            </div>
          </div>

          <div style="margin-top:18px" class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Resumo de Dados</div>
              <div class="muted">Vis√£o r√°pida das √∫ltimas a√ß√µes</div>
            </div>
            <div style="margin-top:12px;display:flex;gap:12px">
              <div style="flex:1">
                <div class="muted">Usu√°rios</div>
                <div style="font-weight:700;font-size:18px" id="totalUsers">0</div>
              </div>
              <div style="flex:1">
                <div class="muted">Treinamentos</div>
                <div style="font-weight:700;font-size:18px" id="totalTrains">0</div>
              </div>
              <div style="flex:1">
                <div class="muted">Previs√µes</div>
                <div style="font-weight:700;font-size:18px" id="totalPreds">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users -->
        <div class="view" id="users" style="display:none">
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">Gerenciar Usu√°rios</div>
              <div>
                <input id="userFilter" placeholder="Filtrar por nome/email" style="background:transparent;border:0;color:var(--muted);outline:0" />
              </div>
            </div>
            <div style="margin-top:12px;overflow:auto">
              <table>
                <thead><tr><th>Nome</th><th>Email</th><th>Perfil</th><th>A√ß√µes</th></tr></thead>
                <tbody id="usersTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Training -->
        <div class="view" id="training" style="display:none">
          <div class="grid">
            <div class="card">
              <div style="font-weight:700">Enviar CSV para Treinamento</div>
              <div class="muted">Formato esperado: colunas com features + coluna 'label' (1 para exoplaneta, 0 para n√£o)</div>
              <label class="upload" for="trainFile">üìÅ Clique ou arraste arquivo para upload (CSV)<input type="file" id="trainFile" accept=".csv"/></label>
              <div style="margin-top:12px"><button class="btn primary" id="startTrain">Iniciar Treinamento (simulado)</button></div>
              <div id="trainPreview" style="margin-top:12px"></div>
            </div>

            <div class="card">
              <div style="font-weight:700">Configura√ß√µes do Treino</div>
              <div style="margin-top:8px">
                <label class="muted">Algoritmo</label>
                <select id="algoSelect" style="width:100%;padding:8px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
                  <option>Random Forest</option>
                  <option>XGBoost</option>
                  <option>Rede Neural</option>
                  <option>√Årvore de Decis√£o</option>
                </select>
              </div>
              <div style="margin-top:12px;">
                <label class="muted">Epocas (simulado)</label>
                <input id="epochs" type="number" min="1" value="10" style="width:100%;padding:8px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"/>
              </div>
            </div>
          </div>
        </div>

        <!-- Predict -->
        <div class="view" id="predict" style="display:none">
          <div class="grid">
            <div class="card">
              <div style="font-weight:700">Enviar dados para previs√£o</div>
              <div class="muted">Envie um CSV com as mesmas colunas usadas no treinamento (sem a coluna label)</div>
              <label class="upload" for="predictFile">üìÅ Upload CSV de previs√£o<input type="file" id="predictFile" accept=".csv"/></label>
              <div style="margin-top:12px"><button class="btn primary" id="runPredict">Executar Previs√µes</button>
              <button class="btn ghost" id="downloadPreds">Baixar CSV</button></div>
              <div id="predictPreview" style="margin-top:12px"></div>
            </div>

            <div class="card">
              <div style="font-weight:700">Resultados</div>
              <canvas id="predChart" height="160"></canvas>
              <div style="margin-top:12px;overflow:auto;max-height:220px">
                <table><thead><tr><th>#</th><th>Probabilidade</th><th>Classe</th></tr></thead><tbody id="predTable"></tbody></table>
              </div>
            </div>
          </div>
        </div>

        <!-- History -->
        <div class="view" id="history" style="display:none">
          <div class="card">
            <div style="font-weight:700">Hist√≥rico de Treinamentos e Previs√µes</div>
            <div id="historyList" style="margin-top:12px"></div>
          </div>
        </div>

        <!-- Settings -->
        <div class="view" id="settings" style="display:none">
          <div class="card">
            <div style="font-weight:700">Configura√ß√µes da Plataforma</div>
            <div style="margin-top:10px" class="muted">Aqui voc√™ pode configurar chaves de API, par√¢metros do modelo e backups.</div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Modal (user form) -->
  <div id="modalRoot" style="display:none"></div>

  <script>
    // Simple SPA navigation
    const menu = document.getElementById('menu');
    const views = document.querySelectorAll('.view');
    menu.addEventListener('click', e => {
      if(!e.target.dataset.view) return;
      document.querySelectorAll('#menu button').forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      const view = e.target.dataset.view;
      views.forEach(v => v.style.display = v.id === view ? 'block' : 'none');
    });

    // Local storage keys
    const USERS_KEY = 'exoadmin_users_v1';
    const TRAIN_KEY = 'exoadmin_trains_v1';
    const PRED_KEY = 'exoadmin_preds_v1';

    // --- Users CRUD (localStorage) ---
    function loadUsers(){
      const raw = localStorage.getItem(USERS_KEY);
      return raw ? JSON.parse(raw) : [];
    }
    function saveUsers(list){ localStorage.setItem(USERS_KEY, JSON.stringify(list)); renderUsers(); }
    function renderUsers(filter=''){
      const tbody = document.getElementById('usersTable'); tbody.innerHTML='';
      const users = loadUsers().filter(u=> (u.name+u.email).toLowerCase().includes(filter.toLowerCase()));
      users.forEach((u,idx)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name}</td><td>${u.email}</td><td>${u.role||'user'}</td><td><button class=\"btn ghost\" data-idx=\"${idx}\" data-act=\"edit\">Editar</button> <button class=\"btn\" data-idx=\"${idx}\" data-act=\"del\">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('totalUsers').innerText = users.length;
    }
    document.getElementById('newUserBtn').addEventListener('click', ()=>openUserModal());
    document.getElementById('usersTable').addEventListener('click', e=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const idx = Number(btn.dataset.idx);
      const act = btn.dataset.act;
      const users = loadUsers();
      if(act==='edit') openUserModal(users[idx], idx);
      if(act==='del'){ if(confirm('Remover usu√°rio?')){ users.splice(idx,1); saveUsers(users); } }
    });
    document.getElementById('userFilter').addEventListener('input', e=>renderUsers(e.target.value));

    function openUserModal(user=null, idx=null){
      const root = document.getElementById('modalRoot');
      root.innerHTML = `<div class="modal-backdrop"><div class="modal"><h3>${user? 'Editar' : 'Criar'} usu√°rio</h3>
        <div style="margin-top:10px"><label>Nome</label><input id="m_name" value="${user?escapeHtml(user.name):''}" style="width:100%;padding:8px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"/></div>
        <div style="margin-top:10px"><label>Email</label><input id="m_email" value="${user?escapeHtml(user.email):''}" style="width:100%;padding:8px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"/></div>
        <div style="margin-top:10px"><label>Perfil</label><select id="m_role" style="width:100%;padding:8px;border-radius:8px;margin-top:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit"><option>user</option><option>admin</option></select></div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn ghost" id="modalCancel">Cancelar</button><button class="btn primary" id="modalSave">Salvar</button></div>
      </div></div>`;
      root.style.display='block';
      if(user) document.getElementById('m_role').value = user.role||'user';
      document.getElementById('modalCancel').addEventListener('click', ()=>{root.style.display='none';root.innerHTML='';});
      document.getElementById('modalSave').addEventListener('click', ()=>{
        const name = document.getElementById('m_name').value.trim();
        const email = document.getElementById('m_email').value.trim();
        const role = document.getElementById('m_role').value;
        if(!name || !email){ alert('Preencha nome e email'); return; }
        const users = loadUsers();
        if(idx!=null){ users[idx] = {name,email,role}; } else { users.push({name,email,role}); }
        saveUsers(users);
        root.style.display='none'; root.innerHTML='';
      });
    }

    function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }

    // Export users
    document.getElementById('exportUsers').addEventListener('click', ()=>{
      const users = loadUsers();
      const csv = users.map(u=>`${u.name},${u.email},${u.role||'user'}`).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='users.csv'; a.click();
    });

    document.getElementById('clearStorage').addEventListener('click', ()=>{ if(confirm('Resetar dados locais?')){ localStorage.clear(); location.reload(); } });

    // --- Training (client-side simulated) ---
    let currentTrainFile = null;
    document.getElementById('trainFile').addEventListener('change', e=>{
      currentTrainFile = e.target.files[0]; previewCSV(currentTrainFile, 'trainPreview');
    });

    document.getElementById('startTrain').addEventListener('click', ()=>{
      if(!currentTrainFile){ alert('Selecione um CSV de treinamento'); return; }
      simulateTraining(currentTrainFile);
    });

    function previewCSV(file, containerId, maxRows=6){
      const reader = new FileReader();
      reader.onload = ()=>{
        const text = reader.result;
        const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
        const preview = rows.slice(0,maxRows);
        const html = `<div class=\"muted\">Preview (primeiras ${preview.length} linhas)</div><div style=\"margin-top:8px;overflow:auto\"><table><thead><tr>${preview[0].map(c=>`<th>${escapeHtml(c)}</th>`).join('')}</tr></thead><tbody>${preview.slice(1).map(r=>`<tr>${r.map(c=>`<td>${escapeHtml(c)}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        document.getElementById(containerId).innerHTML = html;
      };
      reader.readAsText(file);
    }

    function simulateTraining(file){
      // Fake training to produce deterministic-ish accuracy: use file size + name hash
      const seed = (file.name.length * 31 + file.size) % 100;
      const accuracy = Math.min(98, Math.round((50 + seed/2 + Math.random()*10)));
      const entry = {id:Date.now(), name:file.name, acc:accuracy, algorithm:document.getElementById('algoSelect').value, epochs: Number(document.getElementById('epochs').value)};
      const trains = JSON.parse(localStorage.getItem(TRAIN_KEY) || '[]');
      trains.unshift(entry); localStorage.setItem(TRAIN_KEY, JSON.stringify(trains));
      // update model info
      document.getElementById('modelName').innerText = entry.algorithm;
      document.getElementById('modelAcc').innerText = entry.acc + '%';
      document.getElementById('dashModel').innerText = entry.algorithm;
      document.getElementById('dashAcc').innerText = entry.acc + '%';
      renderHistory(); renderDashboard(); alert('Treinamento finalizado (simulado) ‚Äî acur√°cia: ' + entry.acc + '%');
    }

    // --- Prediction (client-side simulated) ---
    let currentPredFile = null; let lastPredictions = [];
    document.getElementById('predictFile').addEventListener('change', e=>{ currentPredFile = e.target.files[0]; previewCSV(currentPredFile, 'predictPreview', 8); });

    document.getElementById('runPredict').addEventListener('click', ()=>{
      if(!currentPredFile){ alert('Selecione um CSV de previs√µes'); return; }
      runPredictions(currentPredFile);
    });

    function runPredictions(file){
      // Simula resposta da API com dados fixos
      setTimeout(()=>{
      // Exemplo de 8 previs√µes fixas
      const data = {
        predictions: [
        {probability: 0.92, class: 1},
        {probability: 0.12, class: 0},
        {probability: 0.67, class: 1},
        {probability: 0.33, class: 0},
        {probability: 0.81, class: 1},
        {probability: 0.44, class: 0},
        {probability: 0.59, class: 1},
        {probability: 0.21, class: 0}
        ]
      };
      lastPredictions = data.predictions.map((p,i)=>({index:i+1, prob:p.probability, class:p.class}));
      renderPredictions();
      }, 500);
    }

    function pseudoRandFromString(s){
      // simple hash to number 0..1
      let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h = Math.imul(h ^ s.charCodeAt(i), 16777619); }
      const frac = (h >>> 0) % 1000 / 1000; // 0..0.999
      // tweak by file size-ish factor
      return Math.min(0.999, Math.max(0.001, frac));
    }

    function renderPredictions(){
      const tbody = document.getElementById('predTable'); tbody.innerHTML='';
      const probs = lastPredictions.map(p=>p.prob);
      lastPredictions.forEach(p=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.index}</td><td>${(p.prob*100).toFixed(1)}%</td><td>${p.class}</td>`; tbody.appendChild(tr); });
      // Chart
      const ctx = document.getElementById('predChart'); if(window.predChart) window.predChart.destroy();
      window.predChart = new Chart(ctx, {type:'bar',data:{labels:lastPredictions.map(p=>p.index),datasets:[{label:'Probabilidade de exoplaneta (%)',data:lastPredictions.map(p=>p.prob*100),borderRadius:6}]},options:{scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}});
    }

    document.getElementById('downloadPreds').addEventListener('click', ()=>{
      if(!lastPredictions.length){ alert('Sem previs√µes para baixar'); return; }
      const csv = ['index,prob,class'].concat(lastPredictions.map(p=>`${p.index},${p.prob},${p.class}`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='predictions.csv'; a.click();
    });

    // --- History & Dashboard rendering ---
    function renderHistory(){
      const hroot = document.getElementById('historyList');
      const trains = JSON.parse(localStorage.getItem(TRAIN_KEY)||'[]');
      const preds = JSON.parse(localStorage.getItem(PRED_KEY)||'[]');
      const html = `<div><div style=\"font-weight:700\">Treinamentos</div>${trains.map(t=>`<div class=\"muted\">${t.algorithm} ‚Äî ${t.name} ‚Äî acur√°cia: ${t.acc}%</div>`).join('')}<div style=\"height:12px\"></div><div style=\"font-weight:700\">Previs√µes</div>${preds.map(p=>`<div class=\"muted\">${p.file} ‚Äî ${p.count} linhas ‚Äî ${new Date(p.created).toLocaleString()}</div>`).join('')}</div>`;
      hroot.innerHTML = html || '<div class="muted">Sem hist√≥rico</div>';

      // trainList and predList
      const tlist = document.getElementById('trainList'); tlist.innerHTML = trains.slice(0,5).map(t=>`<div class=\"muted\">${t.algorithm} - ${t.name} - ${t.acc}%</div>`).join('') || '<div class=\"muted\">Nenhum</div>';
      const plist = document.getElementById('predList'); plist.innerHTML = preds.slice(0,5).map(p=>`<div class=\"muted\">${p.file} - ${p.count} linhas</div>`).join('') || '<div class=\"muted\">Nenhuma</div>';
      document.getElementById('totalTrains').innerText = trains.length;
      document.getElementById('totalPreds').innerText = preds.length;

      // accuracy chart
      const accCtx = document.getElementById('accChart'); if(window.accChart) window.accChart.destroy();
      const accData = trains.slice(0,10).map(t=>t.acc).reverse();
      const accLabels = trains.slice(0,10).map(t=>new Date(t.id).toLocaleString()).reverse();
      window.accChart = new Chart(accCtx, {type:'line',data:{labels:accLabels, datasets:[{label:'Acur√°cia (%)',data:accData,fill:true}]},options:{scales:{y:{beginAtZero:true,max:100}}}});
    }

    function renderDashboard(){
      const trains = JSON.parse(localStorage.getItem(TRAIN_KEY)||'[]');
      if(trains[0]){ document.getElementById('modelName').innerText = trains[0].algorithm; document.getElementById('modelAcc').innerText = trains[0].acc + '%'; }
    }

    // Init
    renderUsers(); renderHistory(); renderDashboard();

    // Search box quick filter (applies to users list only for demo)
    document.getElementById('search').addEventListener('input', e=>{ renderUsers(e.target.value); });

    // small helper to keep UI tidy on first load
    if(!localStorage.getItem(USERS_KEY)){
      localStorage.setItem(USERS_KEY, JSON.stringify([{name:'Admin',email:'admin@example.com',role:'admin'}])); renderUsers(); }
  </script>
  <script src="js/jquery-3.7.1.min.js"></script>
</body>
</html>
